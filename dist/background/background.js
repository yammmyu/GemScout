chrome.runtime.onInstalled.addListener(()=>{console.log("GemScout extension installed"),chrome.storage.sync.get(["gemscout_settings"],e=>{if(!e.gemscout_settings){const o={autoAnalyze:!0,showOverlay:!0,jobSites:["linkedin.com","indeed.com","glassdoor.com"],matchThreshold:70,notifications:!0};chrome.storage.sync.set({gemscout_settings:o}),console.log("Default settings initialized")}})});chrome.action.onClicked.addListener(e=>{console.log("Extension icon clicked for tab:",e.url)});let r=null;chrome.runtime.onConnect.addListener(e=>{console.log("Port connected:",e.name),e.name==="popup-stream"&&(r=e,e.onDisconnect.addListener(()=>{console.log("Popup port disconnected"),r=null}))});chrome.runtime.onMessage.addListener((e,o,a)=>{var t;switch(console.log("Background received message:",e.type||e.action),e.type||e.action){case"jobs_update":r&&o.tab&&(console.log(`📢 Forwarding job update: ${e.count} jobs available`),r.postMessage({type:"jobs_update",count:e.count,jobs:e.jobs}));break;case"jobs_found":r&&o.tab&&(console.log(`📢 Forwarding jobs found: ${e.jobs.length} new jobs (total: ${e.totalJobs})`),r.postMessage({type:"jobs_update",count:e.totalJobs,jobs:e.jobs,batchNumber:e.batchNumber,isComplete:e.isComplete}));break;case"analysis_complete":r&&o.tab&&(console.log(`🏁 Analysis complete: ${e.totalJobs} total jobs found`),r.postMessage({type:"jobs_update",count:e.totalJobs,jobs:[],isComplete:!0}));break;case"analysis_error":r&&o.tab&&(console.log(`❌ Analysis error: ${e.error}`),r.postMessage({type:"analysis_error",error:e.error,isComplete:!0}));break;case"TOGGLE_OVERLAY":if((t=o.tab)!=null&&t.id)return chrome.tabs.sendMessage(o.tab.id,{type:"TOGGLE_OVERLAY"},n=>{a(n||{success:!1,error:"No response from content script"})}),!0;break;case"start_discovery":return console.log("Starting streaming discovery process..."),console.log("Max jobs requested:",e.maxJobs||5),chrome.tabs.query({active:!0,currentWindow:!0},n=>{var i,l;if((i=n[0])!=null&&i.id&&((l=n[0])!=null&&l.url)){const s=n[0];if(console.log("Active tab identified:",s.url),s.url.startsWith("chrome://")||s.url.startsWith("chrome-extension://")||s.url.startsWith("moz-extension://")){console.error("Cannot run content script on Chrome internal pages:",s.url),a({success:!1,error:"Content scripts cannot run on Chrome internal pages. Please navigate to a regular webpage (http:// or https://) and try again."});return}chrome.scripting.executeScript({target:{tabId:s.id},func:()=>typeof window.gemscoutLoaded<"u"},c=>{var g;((g=c==null?void 0:c[0])==null?void 0:g.result)===!0?(console.log("Content script already loaded, starting streaming analysis"),m(s.id,a,e.maxJobs)):(console.log("Content script not detected, injecting..."),chrome.scripting.executeScript({target:{tabId:s.id},files:["content/contentScript.js"]},()=>{if(chrome.runtime.lastError){console.error("Failed to inject content script:",chrome.runtime.lastError.message),a({success:!1,error:"Failed to inject content script: "+chrome.runtime.lastError.message});return}setTimeout(()=>{m(s.id,a,e.maxJobs)},100)}))})}else console.error("No active tab found"),a({success:!1,error:"No active tab found"})}),!0;default:console.log("Unknown message type:",e.type),a({success:!1,error:"Unknown message type"})}});function m(e,o,a){console.log("🌊 Starting streaming analysis for tab:",e),chrome.tabs.sendMessage(e,{action:"extract_snapshot"},t=>{if(chrome.runtime.lastError){console.error("Error getting snapshot:",chrome.runtime.lastError.message),o({success:!1,error:"Failed to get page snapshot"});return}if(!t||t.error){console.error("Snapshot error:",t==null?void 0:t.error),o({success:!1,error:(t==null?void 0:t.error)||"Failed to collect snapshot"});return}console.log("✅ Snapshot received, starting streaming analysis..."),chrome.tabs.sendMessage(e,{action:"analyze_with_ai",snapshot:t,maxJobs:a},n=>{if(chrome.runtime.lastError){console.error("Analysis error:",chrome.runtime.lastError.message),o({success:!1,error:"Failed to start analysis"});return}console.log("✅ Streaming analysis started successfully"),o({success:!0,message:"Streaming analysis started - jobs will appear as they are found",streaming:!0})})})}
