chrome.runtime.onInstalled.addListener(()=>{console.log("GemScout extension installed"),chrome.storage.sync.get(["gemscout_settings"],o=>{if(!o.gemscout_settings){const r={autoAnalyze:!0,showOverlay:!0,jobSites:["linkedin.com","indeed.com","glassdoor.com"],matchThreshold:70,notifications:!0};chrome.storage.sync.set({gemscout_settings:r}),console.log("Default settings initialized")}})});chrome.action.onClicked.addListener(o=>{console.log("Extension icon clicked for tab:",o.url)});chrome.runtime.onMessage.addListener((o,r,e)=>{var n;switch(console.log("Message received:",o),o.type){case"PAGE_ANALYZED":console.log("Page analyzed:",o.data),chrome.storage.local.get(["page_analyses"],t=>{var i;const s=t.page_analyses||[];s.unshift({...o.data,timestamp:Date.now(),tabId:(i=r.tab)==null?void 0:i.id}),s.length>50&&s.splice(50),chrome.storage.local.set({page_analyses:s})}),chrome.storage.sync.get(["gemscout_settings"],t=>{const s=t.gemscout_settings;s!=null&&s.notifications&&o.data.jobIndicators&&chrome.notifications.create({type:"basic",iconUrl:"assets/icon-48.png",title:"GemScout",message:"Job opportunities detected on this page!"})}),e({success:!0});break;case"GET_ANALYSES":return chrome.storage.local.get(["page_analyses"],t=>{e({success:!0,analyses:t.page_analyses||[]})}),!0;case"CLEAR_ANALYSES":return chrome.storage.local.remove(["page_analyses"],()=>{e({success:!0})}),!0;case"TOGGLE_OVERLAY":if((n=r.tab)!=null&&n.id)return chrome.tabs.sendMessage(r.tab.id,{type:"TOGGLE_OVERLAY"},t=>{e(t||{success:!1,error:"No response from content script"})}),!0;break;case"ANALYZE_CURRENT_TAB":return chrome.tabs.query({active:!0,currentWindow:!0},t=>{var s;(s=t[0])!=null&&s.id?chrome.tabs.sendMessage(t[0].id,{type:"ANALYZE_PAGE"},i=>{e(i||{success:!1,error:"No response from content script"})}):e({success:!1,error:"No active tab found"})}),!0;case"start_discovery":return console.log("Starting discovery process..."),chrome.tabs.query({active:!0,currentWindow:!0},t=>{var s,i;if((s=t[0])!=null&&s.id&&((i=t[0])!=null&&i.url)){const c=t[0];if(console.log("Active tab identified:",c.url),c.url.startsWith("chrome://")||c.url.startsWith("chrome-extension://")||c.url.startsWith("moz-extension://")){console.error("Cannot run content script on Chrome internal pages:",c.url),e({success:!1,error:"Content scripts cannot run on Chrome internal pages. Please navigate to a regular webpage (http:// or https://) and try again."});return}chrome.scripting.executeScript({target:{tabId:c.id},func:()=>typeof window.gemscoutLoaded<"u"},a=>{var l;((l=a==null?void 0:a[0])==null?void 0:l.result)===!0?(console.log("Content script already loaded, sending message directly"),g(c.id,e)):(console.log("Content script not detected, injecting..."),chrome.scripting.executeScript({target:{tabId:c.id},files:["content/contentScript.js"]},()=>{if(chrome.runtime.lastError){console.error("Failed to inject content script:",chrome.runtime.lastError.message),e({success:!1,error:"Failed to inject content script: "+chrome.runtime.lastError.message});return}setTimeout(()=>{g(c.id,e)},100)}))})}else console.error("No active tab found"),e({success:!1,error:"No active tab found"})}),!0;default:console.log("Unknown message type:",o.type),e({success:!1,error:"Unknown message type"})}});function g(o,r){chrome.tabs.sendMessage(o,{action:"extract_snapshot"},e=>{if(chrome.runtime.lastError){console.error("Error communicating with content script:",chrome.runtime.lastError.message||chrome.runtime.lastError),r({success:!1,error:chrome.runtime.lastError.message||"Failed to communicate with content script"});return}e&&!e.error?(console.log("=== DOM SNAPSHOT RECEIVED ==="),console.log("URL:",e.url),console.log("Text Length:",e.text.length),console.log("Links Count:",e.links.length),console.log("Text Sample (first 200 chars):",e.text.substring(0,200)+"..."),console.log("Links Sample (first 5):",e.links.slice(0,5)),console.log("=== END SNAPSHOT ==="),chrome.storage.local.set({lastSnapshot:{...e,timestamp:Date.now(),tabId:o}}),r({success:!0,snapshot:e,message:"DOM snapshot extracted successfully"})):(console.error("Failed to extract snapshot:",e==null?void 0:e.error),r({success:!1,error:(e==null?void 0:e.error)||"No snapshot received"}))})}chrome.tabs.onUpdated.addListener((o,r,e)=>{r.status==="complete"&&e.url&&chrome.storage.sync.get(["gemscout_settings"],n=>{const t=n.gemscout_settings;t!=null&&t.autoAnalyze&&(t.jobSites||["linkedin.com","indeed.com","glassdoor.com"]).some(c=>{var a;return(a=e.url)==null?void 0:a.includes(c)})&&setTimeout(()=>{chrome.tabs.sendMessage(o,{type:"ANALYZE_PAGE"})},2e3)})});chrome.runtime.onStartup.addListener(()=>{chrome.storage.sync.get(["gemscout_settings"],o=>{const r=o.gemscout_settings;r!=null&&r.notifications&&chrome.notifications.getPermissionLevel(e=>{e!=="granted"&&console.log("Notification permission not granted")})})});
