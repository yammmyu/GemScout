chrome.runtime.onInstalled.addListener(()=>{console.log("GemScout extension installed"),chrome.storage.sync.get(["gemscout_settings"],r=>{if(!r.gemscout_settings){const c={autoAnalyze:!0,showOverlay:!0,jobSites:["linkedin.com","indeed.com","glassdoor.com"],matchThreshold:70,notifications:!0};chrome.storage.sync.set({gemscout_settings:c}),console.log("Default settings initialized")}})});chrome.action.onClicked.addListener(r=>{console.log("Extension icon clicked for tab:",r.url)});chrome.runtime.onMessage.addListener((r,c,o)=>{var i;switch(console.log("Message received:",r),r.type){case"PAGE_ANALYZED":console.log("Page analyzed:",r.data),chrome.storage.local.get(["page_analyses"],e=>{var a;const s=e.page_analyses||[];s.unshift({...r.data,timestamp:Date.now(),tabId:(a=c.tab)==null?void 0:a.id}),s.length>50&&s.splice(50),chrome.storage.local.set({page_analyses:s})}),chrome.storage.sync.get(["gemscout_settings"],e=>{const s=e.gemscout_settings;s!=null&&s.notifications&&r.data.jobIndicators&&chrome.notifications.create({type:"basic",iconUrl:"assets/icon-48.png",title:"GemScout",message:"Job opportunities detected on this page!"})}),o({success:!0});break;case"GET_ANALYSES":return chrome.storage.local.get(["page_analyses"],e=>{o({success:!0,analyses:e.page_analyses||[]})}),!0;case"CLEAR_ANALYSES":return chrome.storage.local.remove(["page_analyses"],()=>{o({success:!0})}),!0;case"TOGGLE_OVERLAY":if((i=c.tab)!=null&&i.id)return chrome.tabs.sendMessage(c.tab.id,{type:"TOGGLE_OVERLAY"},e=>{o(e||{success:!1,error:"No response from content script"})}),!0;break;case"ANALYZE_CURRENT_TAB":return chrome.tabs.query({active:!0,currentWindow:!0},e=>{var s;(s=e[0])!=null&&s.id?chrome.tabs.sendMessage(e[0].id,{type:"ANALYZE_PAGE"},a=>{o(a||{success:!1,error:"No response from content script"})}):o({success:!1,error:"No active tab found"})}),!0;case"start_discovery":return console.log("Starting discovery process..."),chrome.tabs.query({active:!0,currentWindow:!0},e=>{var s;if((s=e[0])!=null&&s.id){const a=e[0];console.log("Active tab identified:",a.url),chrome.tabs.sendMessage(a.id,{action:"extract_snapshot"},t=>{if(chrome.runtime.lastError){console.error("Error communicating with content script:",chrome.runtime.lastError),o({success:!1,error:chrome.runtime.lastError.message});return}t&&!t.error?(console.log("=== DOM SNAPSHOT RECEIVED ==="),console.log("URL:",t.url),console.log("Text Length:",t.text.length),console.log("Links Count:",t.links.length),console.log("Text Sample (first 200 chars):",t.text.substring(0,200)+"..."),console.log("Links Sample (first 5):",t.links.slice(0,5)),console.log("=== END SNAPSHOT ==="),chrome.storage.local.set({lastSnapshot:{...t,timestamp:Date.now(),tabId:a.id}}),o({success:!0,snapshot:t,message:"DOM snapshot extracted successfully"})):(console.error("Failed to extract snapshot:",t==null?void 0:t.error),o({success:!1,error:(t==null?void 0:t.error)||"No snapshot received"}))})}else console.error("No active tab found"),o({success:!1,error:"No active tab found"})}),!0;default:console.log("Unknown message type:",r.type),o({success:!1,error:"Unknown message type"})}});chrome.tabs.onUpdated.addListener((r,c,o)=>{c.status==="complete"&&o.url&&chrome.storage.sync.get(["gemscout_settings"],i=>{const e=i.gemscout_settings;e!=null&&e.autoAnalyze&&(e.jobSites||["linkedin.com","indeed.com","glassdoor.com"]).some(t=>{var n;return(n=o.url)==null?void 0:n.includes(t)})&&setTimeout(()=>{chrome.tabs.sendMessage(r,{type:"ANALYZE_PAGE"})},2e3)})});chrome.runtime.onStartup.addListener(()=>{chrome.storage.sync.get(["gemscout_settings"],r=>{const c=r.gemscout_settings;c!=null&&c.notifications&&chrome.notifications.getPermissionLevel(o=>{o!=="granted"&&console.log("Notification permission not granted")})})});
